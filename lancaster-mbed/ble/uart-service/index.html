<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta property="og:image" content="../../../img/logo.png"/>

  
  <meta name="author" content="Doãn Minh Đăng">
  
  <title>UARTService - Microbit Việt Nam</title>
  

  <link rel="shortcut icon" href="../../../img/favicon.ico">

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../../css/highlight.css">
  <link href="../../../lancaster-mbed/resources/bluetooth/style.css" rel="stylesheet">

  <link rel="stylesheet" href="../../../css/custom.css">

  
  <script>
    // Current page data
    var mkdocs_page_name = "UARTService";
    var mkdocs_page_input_path = "lancaster-mbed/ble/uart-service.md";
    var mkdocs_page_url = "/lancaster-mbed/ble/uart-service/";
  </script>
  
  <script src="../../../js/jquery-2.1.1.min.js"></script>
  <script src="../../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../../js/highlight.pack.js"></script>
  <script src="../../../js/theme.js"></script>
  <script src="../../../js/jquery.cookie-1.4.1.min.js"></script>
  <script src="../../../js/nav.js"></script> 
  <script src="../../../lancaster-mbed/resources/bluetooth/functions.js"></script>

  
  <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-60470603-6', 'help.microbit.vn');
      ga('send', 'pageview');
  </script>
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../../.." class="icon icon-home"> Microbit Việt Nam</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        <ul class="current">
          
            <li><ul class="subnav">
    <li class="">
        <a class="" href="../../.." id="Trang chủ" style="font-size:95%;font-weight:bold;">Trang chủ</a>
    </li>
    
    <li class="paddingtop20"></li>
</ul>
<li>
          
            <li><ul class="subnav">
    <li class="current">
        <a class="current"  id="Nội dung" style="font-size:95%;font-weight:bold;">Nội dung</a>
    </li>
    
        <li class="current">
            <a style="padding-left:50px;" class="current"  id="micro:bit - Mbed - C/C++" onclick="showChildren('micro:bit - Mbed - C/C++')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i> micro:bit - Mbed - C/C++</a>
        </li>
        
        <div style="display:none" id="hidden_micro:bit - Mbed - C/C++">
        
            <li class="">
                <a style="padding-left:70px;" class=""  id="Thông tin chung" onclick="showChildren('micro:bit - Mbed - C/C++Thông tin chung')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i>  Thông tin chung </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_micro:bit - Mbed - C/C++Thông tin chung">
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../" id="Giới thiệu">Giới thiệu </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../concepts/" id="Các khái niệm">Các khái niệm </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../advanced/" id="Nâng cao">Nâng cao </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../online-toolchains/" id="Phát triển trên web">Phát triển trên web </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../offline-toolchains/" id="Phát triển offline">Phát triển offline </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../device/" id="Phần cứng">Phần cứng </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../help/" id="Giúp đỡ">Giúp đỡ </a>
                </li>
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class=""  id="uBit" onclick="showChildren('micro:bit - Mbed - C/C++Thông tin chunguBit')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i>  uBit </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_micro:bit - Mbed - C/C++Thông tin chunguBit">
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../ubit/" id="Overview">Overview </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../ubit/i2c/" id="i2c">i2c </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../ubit/storage/" id="storage">storage </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../ubit/serial/" id="serial">serial </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../ubit/messageBus/" id="messageBus">messageBus </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../ubit/button/" id="buttons">buttons </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../ubit/display/" id="display">display </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../ubit/accelerometer/" id="accelerometer">accelerometer </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../ubit/compass/" id="compass">compass </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../ubit/thermometer/" id="thermometer">thermometer </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../ubit/io/" id="io">io </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../ubit/radio/" id="radio">radio </a>
                </li>
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class=""  id="Data Types" onclick="showChildren('micro:bit - Mbed - C/C++Thông tin chunguBitData Types')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i>  Data Types </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_micro:bit - Mbed - C/C++Thông tin chunguBitData Types">
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../data-types/image/" id="MicroBitImage">MicroBitImage </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../data-types/event/" id="MicroBitEvent">MicroBitEvent </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../data-types/string/" id="ManagedString">ManagedString </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../data-types/packetbuffer/" id="PacketBuffer">PacketBuffer </a>
                </li>
            
            </div>
        
            <li class="current">
                <a style="padding-left:70px;" class="current"  id="Bluetooth" onclick="showChildren('micro:bit - Mbed - C/C++Thông tin chunguBitData TypesBluetooth')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i>  Bluetooth </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_micro:bit - Mbed - C/C++Thông tin chunguBitData TypesBluetooth">
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../profile/" id="Profile">Profile </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../accelerometer-service/" id="AccelerometerService">AccelerometerService </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../button-service/" id="ButtonService">ButtonService </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../dfu-service/" id="DFUService">DFUService </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../event-service/" id="EventService">EventService </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../iopin-service/" id="IOPinService">IOPinService </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../led-service/" id="LEDService">LEDService </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../magnetometer-service/" id="MagnetometerService">MagnetometerService </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../temperature-service/" id="TemperatureService">TemperatureService </a>
                </li>
            
                <li class="current">
                    <a style="padding-left:90px;" class="current" href="./" id="UARTService">UARTService </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../ble-connection-events/" id="Connection Events">Connection Events </a>
                </li>
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class=""  id="Extras" onclick="showChildren('micro:bit - Mbed - C/C++Thông tin chunguBitData TypesBluetoothExtras')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i>  Extras </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_micro:bit - Mbed - C/C++Thông tin chunguBitData TypesBluetoothExtras">
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../extras/light-sensing/" id="MicroBitLightSensor">MicroBitLightSensor </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../extras/spi/" id="SPI">SPI </a>
                </li>
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class="" href="../../ubit/blemanager/" id="_blemanager">  _blemanager </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_micro:bit - Mbed - C/C++Thông tin chunguBitData TypesBluetoothExtras_blemanager">
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class="" href="../../ubit/multibutton/" id="_buttonAB">  _buttonAB </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_micro:bit - Mbed - C/C++Thông tin chunguBitData TypesBluetoothExtras_blemanager_buttonAB">
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class="" href="../../ubit/radioevent/" id="_radioevent">  _radioevent </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_micro:bit - Mbed - C/C++Thông tin chunguBitData TypesBluetoothExtras_blemanager_buttonAB_radioevent">
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class="" href="../../ubit/radiodatagram/" id="_radiodatagram">  _radiodatagram </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_micro:bit - Mbed - C/C++Thông tin chunguBitData TypesBluetoothExtras_blemanager_buttonAB_radioevent_radiodatagram">
            
            </div>
        
        </div>
    
        <li class="">
            <a style="padding-left:50px;" class=""  id="micro:bit - Micropython" onclick="showChildren('micro:bit - Micropython')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i> micro:bit - Micropython</a>
        </li>
        
        <div style="display:none" id="hidden_micro:bit - Micropython">
        
            <li class="">
                <a style="padding-left:70px;" class="" href="../../../micropython/introduction/" id="Giới thiệu">  Giới thiệu </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_micro:bit - MicropythonGiới thiệu">
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class=""  id="Cơ bản" onclick="showChildren('micro:bit - MicropythonGiới thiệuCơ bản')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i>  Cơ bản </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_micro:bit - MicropythonGiới thiệuCơ bản">
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../../micropython/helloworld/" id="Hello World">Hello World </a>
                </li>
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../../micropython/images/" id="Ảnh">Ảnh </a>
                </li>
            
            </div>
        
            <li class="">
                <a style="padding-left:70px;" class=""  id="micro:bit micropython API" onclick="showChildren('micro:bit - MicropythonGiới thiệuCơ bảnmicro:bit micropython API')"> <i class="fa fa-plus-square" style="padding-left:5px;font-size:13px;"></i>  micro:bit micropython API </a>
                <!--  -->
            </li>
            
            <div style="display:none" id="hidden_micro:bit - MicropythonGiới thiệuCơ bảnmicro:bit micropython API">
            
                <li class="">
                    <a style="padding-left:90px;" class="" href="../../../micropython/api/" id="API">API </a>
                </li>
            
            </div>
        
        </div>
    
    <li class="paddingtop20"></li>
</ul>
<li>
          
            <li><ul class="subnav">
    <li class="">
        <a class="" href="../../../projects/projects/" id="Các dự án" style="font-size:95%;font-weight:bold;">Các dự án</a>
    </li>
    
    <li class="paddingtop20"></li>
</ul>
<li>
          
            <li><ul class="subnav">
    <li class="">
        <a class="" href="../../../license/" id="Bản quyền" style="font-size:95%;font-weight:bold;">Bản quyền</a>
    </li>
    
    <li class="paddingtop20"></li>
</ul>
<li>
          
            <li><ul class="subnav">
    <li class="">
        <a class="" href="../../../contributor/" id="Đóng góp" style="font-size:95%;font-weight:bold;">Đóng góp</a>
    </li>
    
    <li class="paddingtop20"></li>
</ul>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../..">Microbit Việt Nam</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
    <ul class="wy-breadcrumbs">
        <li><a href="../../..">Docs</a> &raquo;</li>
          
        <li>micro:bit - Mbed - C/C++ &raquo;</li>
          
        <li>Bluetooth &raquo;</li>
           
        <li>UARTService</li>
        <li class="wy-breadcrumbs-aside">
             
                
            <a href="https://github.com/microbitvn/help.microbit.vn/tree/master/docs/lancaster-mbed/ble/uart-service.md" class="icon icon-github"> Edit on GitHub</a>
                
             
        </li>
    </ul>
    <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="bluetooth-uart-service">Bluetooth UART Service<a class="headerlink" href="#bluetooth-uart-service" title="Permanent link">#</a></h1>
<h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">#</a></h2>
<p>This Bluetooth Low Energy (BLE) service is an optional part of the standard bluetooth profile for the micro:bit. It is a passive service, that can operate transparently in the background as your main program is running. It provides a form of serial data communications capability over Bluetooth low energy and can be used to exchange arbitrary sequences of bytes in either direction between micro:bit and connected peer.</p>
<h2 id="enabling-and-using-the-service">Enabling and Using the Service<a class="headerlink" href="#enabling-and-using-the-service" title="Permanent link">#</a></h2>
<p>This service is disabled by default. To enable the service, create an instance of this class in your program at any time after the uBit object has been initialised. Send data from the micro:bit to the connected peer at any time using one of the send methods of the MicroBitUARTService class. To receive data from the connected peer use one of several methods such as readUntil which blocks until a specified delimiter value is received and then returns all previous octets in the receive buffer. Consult the API for details.</p>
<p>Note that it may make sense to coordinate use of the UART service with the state of the Bluetooth connection, only reading or sending serial data when there is an active Bluetooth connection. Two micro:bit message bus events are provided for this purpose. A full example appears below.</p>
<pre class="code"><code class="language-cpp">MicroBitUARTService *uart;   </code></pre>


<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Using Bluetooth services is memory hungry. By default, some of the memory normally used by Nordic&rsquo;s Bluetooth protocol stack (known as a SoftDevice), is reclaimed by the micro:bit runtime as general purpose memory for your applications. if you enable more Bluetooth services, then you may need to provide more memory back to Soft Device to ensure proper operation. If after enabling this service your Bluetooth application cannot access the service reliably, you should consider increasing the value of MICROBIT_SD_GATT_TABLE_SIZE in your inc/MicroBitConfig.h. The more service you add, the larger this will need to be, up to the limit defined in MicroBitConfig.h.</p>
</div>
<h2 id="bluetooth-service-specification">Bluetooth Service Specification<a class="headerlink" href="#bluetooth-service-specification" title="Permanent link">#</a></h2>
<p>Please see the <a href="../../resources/bluetooth/microbit-profile-V1.9-Level-2.pdf">micro:bit Bluetooth profile specification</a>.</p>
<h2 id="example-microbit-application-animal-vegetable-mineral-game">Example micro:bit application - Animal Vegetable Mineral game<a class="headerlink" href="#example-microbit-application-animal-vegetable-mineral-game" title="Permanent link">#</a></h2>
<pre class="code"><code class="language-cpp">#include &quot;MicroBit.h&quot;
#include &quot;MicroBitSamples.h&quot;
#include &quot;MicroBitUARTService.h&quot;
MicroBit uBit;
MicroBitUARTService *uart;

int connected = 0;

void onConnected(MicroBitEvent e)
{
    uBit.display.scroll(&quot;C&quot;);

    connected = 1;

    // my client will send ASCII strings terminated with the colon character
    ManagedString eom(&quot;:&quot;);

    while (connected == 1) {
        ManagedString msg = uart-&gt;readUntil(eom);
        uBit.display.scroll(msg);
    }

}

void onDisconnected(MicroBitEvent e)
{
    uBit.display.scroll(&quot;D&quot;);
    connected = 0;
}

void onButtonA(MicroBitEvent e)
{
    if (connected == 0) {
        uBit.display.scroll(&quot;NC&quot;);
        return;
    }
    uart-&gt;send(&quot;YES&quot;);
    uBit.display.scroll(&quot;YES&quot;);
}

void onButtonB(MicroBitEvent e)
{
    if (connected == 0) {
        uBit.display.scroll(&quot;NC&quot;);
        return;
    }
    uart-&gt;send(&quot;NO&quot;);
    uBit.display.scroll(&quot;NO&quot;);
}

void onButtonAB(MicroBitEvent e)
{
    if (connected == 0) {
        uBit.display.scroll(&quot;NC&quot;);
        return;
    }
    uart-&gt;send(&quot;GOT IT!!&quot;);
    uBit.display.scroll(&quot;GOT IT!!&quot;);
}

/*
Recommend disabling the DFU and Event services in MicroBitConfig.h since they are not needed here:

#ifndef MICROBIT_BLE_DFU_SERVICE
#define MICROBIT_BLE_DFU_SERVICE                0
#endif

#ifndef MICROBIT_BLE_EVENT_SERVICE
#define MICROBIT_BLE_EVENT_SERVICE              0
#endif
*/

int main()
{
    // Initialise the micro:bit runtime.
    uBit.init();

    // listen for Bluetooth connection state changes
    uBit.messageBus.listen(MICROBIT_ID_BLE, MICROBIT_BLE_EVT_CONNECTED, onConnected);
    uBit.messageBus.listen(MICROBIT_ID_BLE, MICROBIT_BLE_EVT_DISCONNECTED, onDisconnected);

    // listen for user button interactions
    uBit.messageBus.listen(MICROBIT_ID_BUTTON_A, MICROBIT_BUTTON_EVT_CLICK, onButtonA);
    uBit.messageBus.listen(MICROBIT_ID_BUTTON_B, MICROBIT_BUTTON_EVT_CLICK, onButtonB);
    uBit.messageBus.listen(MICROBIT_ID_BUTTON_AB, MICROBIT_BUTTON_EVT_CLICK, onButtonAB);


    // Note GATT table size increased from default in MicroBitConfig.h
    // #define MICROBIT_SD_GATT_TABLE_SIZE             0x500
    uart = new MicroBitUARTService(*uBit.ble, 32, 32); 
    uBit.display.scroll(&quot;AVM&quot;);

    // If main exits, there may still be other fibers running or registered event handlers etc.
    // Simply release this fiber, which will mean we enter the scheduler. Worse case, we then
    // sit in the idle task forever, in a power efficient sleep.
    release_fiber();
}</code></pre>


<p><strong>Known Issue</strong> In the onConnected event handler method, the call to ManagedString msg = uart-&gt;readUntil(eom); blocks until the specified end of message character is received. This prevents the event handler from exiting. Under normal circumstances this is fine. If however the connected application loses its connection and then reconnects, the onConnected method will not execute and therefore the &lsquo;connected&rsquo; variable which tracks the Bluetooth connection state will not update. The micro:bit application will now behave as though it is not in a connection and therefore functions such as sending text by pressing a button will not work. In this situation the user should simply reset their micro:bit and reconnect their smartphone application. An API which allows serial reads to unblock or perhaps threads to be terminated is under consideration for a future release of the micro:bit runtime.  </p>
<h2 id="example-applications-for-androidiosandroid">Example Applications for Android/IOS/Android<a class="headerlink" href="#example-applications-for-androidiosandroid" title="Permanent link">#</a></h2>
<h3 id="general-procedures">General Procedures<a class="headerlink" href="#general-procedures" title="Permanent link">#</a></h3>
<p>A connected peer such as a smartphone application can transmit data to the micro:bit, up to a maximum of 20 octets at a time by writing to the RX Characteristic. Either of the Write Request or Write Command (i.e. write with no response) PDUs may be used by the client. </p>
<p>See the profile page and profile reference documentation UUID details.</p>
<h3 id="android">Android<a class="headerlink" href="#android" title="Permanent link">#</a></h3>
<p><img src="../../resources/bluetooth/uart_demo.png" alt="UART Demo"></p>
<h4 id="android-bluetooth-apis">Android Bluetooth APIs<a class="headerlink" href="#android-bluetooth-apis" title="Permanent link">#</a></h4>
<p>Android developers should make themselves familiar with the <a href="http://developer.android.com/guide/topics/connectivity/bluetooth-le.html">Android Bluetooth low energy APIs</a></p>
<h4 id="microbit-ble-demo-android">microbit-ble-demo-android<a class="headerlink" href="#microbit-ble-demo-android" title="Permanent link">#</a></h4>
<p>The open source microbit-ble-demo-android application contains a demonstration of the micro:bit Bluetooth UART service in the form of a guessing game called Animal Vegetable Mineral. The main body of code for this demonstration can be found in ui.UartAvmActivity.java except for the Bluetooth operations themselves which are in bluetooth.BleAdapterService which acts as a kind of higher level Bluetooth API for activities to use without needing to directly concern themselves too closely with the Android APIs themselves. In most cases, operations are asynchronous so that the activity code initiates a Bluetooth operation by calling one of the methods in bluetooth.BleAdapterService (e.g. readCharacteristic(....) ) and later receives a message containing the result of the operation from this object via a Handler object. The message is examined in the Handler code and acted upon.</p>
<p>Key parts of the magnetometer demonstration in this application are explained next.</p>
<h4 id="in-bluetoothbleadapterservice">In bluetooth.BleAdapterService<a class="headerlink" href="#in-bluetoothbleadapterservice" title="Permanent link">#</a></h4>
<pre class="code"><code class="language-java">public static String UARTSERVICE_SERVICE_UUID = &quot;6E400001B5A3F393E0A9E50E24DCCA9E&quot;;
public static String UART_RX_CHARACTERISTIC_UUID = &quot;6E400002B5A3F393E0A9E50E24DCCA9E&quot;;
public static String UART_TX_CHARACTERISTIC_UUID = &quot;6E400003B5A3F393E0A9E50E24DCCA9E&quot;;</code></pre>


<h4 id="in-uiuartavmactivity">In ui.UartAvmActivity<a class="headerlink" href="#in-uiuartavmactivity" title="Permanent link">#</a></h4>
<pre class="code"><code class="language-java">// enabling indications on the UART TX characteristic
if (bluetooth_le_adapter.setIndicationsState(Utility.normaliseUUID(BleAdapterService.UARTSERVICE_SERVICE_UUID), Utility.normaliseUUID(BleAdapterService.UART_TX_CHARACTERISTIC_UUID), true)) {
    showMsg(Utility.htmlColorGreen(&quot;UART TX indications ON&quot;));
} else {
    showMsg(Utility.htmlColorRed(&quot;Failed to set UART TX indications ON&quot;));
}</code></pre>


<pre class="code"><code class="language-java">// handling indications
case BleAdapterService.NOTIFICATION_OR_INDICATION_RECEIVED:
    bundle = msg.getData();
    service_uuid = bundle.getString(BleAdapterService.PARCEL_SERVICE_UUID);
    characteristic_uuid = bundle.getString(BleAdapterService.PARCEL_CHARACTERISTIC_UUID);
    b = bundle.getByteArray(BleAdapterService.PARCEL_VALUE);
    if (characteristic_uuid.equalsIgnoreCase((Utility.normaliseUUID(BleAdapterService.UART_TX_CHARACTERISTIC_UUID)))) {
        String ascii=&quot;&quot;;
        try {
            ascii = new String(b,&quot;US-ASCII&quot;);
        } catch (UnsupportedEncodingException e) {
            e.printStackTrace();
            showMsg(Utility.htmlColorGreen(&quot;Could not convert TX data to ASCII&quot;));
            return;
        }
        if (!ascii.equals(Constants.AVM_CORRECT_RESPONSE)) {
            showAnswer(ascii);
        } else {
            showAnswer(ascii+&quot; You only needed &quot;+guess_count+&quot; guesses!&quot;);
        }
    }
    break; </code></pre>


<pre class="code"><code class="language-java">// sending data to the micro:bit by writing to the RX Characteristic
public void onSendText(View view) {
    EditText text = (EditText) UartAvmActivity.this.findViewById(R.id.avm_question_text);
    try {
        String question = text.getText().toString() + &quot;:&quot;;
        byte[] ascii_bytes = question.getBytes(&quot;US-ASCII&quot;);
        bluetooth_le_adapter.writeCharacteristic(Utility.normaliseUUID(BleAdapterService.UARTSERVICE_SERVICE_UUID), Utility.normaliseUUID(BleAdapterService.UART_RX_CHARACTERISTIC_UUID), ascii_bytes);
        guess_count++;
        showGuessCount();
    } catch (UnsupportedEncodingException e) {
        e.printStackTrace();
        showMsg(&quot;Unable to convert text to ASCII bytes&quot;);
    }
}</code></pre>


<h4 id="video-demonstration">Video Demonstration<a class="headerlink" href="#video-demonstration" title="Permanent link">#</a></h4>
<iframe src="https://player.vimeo.com/video/164622668" width="750" height="422" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../ble-connection-events/" class="btn btn-neutral float-right" title="Connection Events">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../temperature-service/" class="btn btn-neutral" title="TemperatureService"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
      <p>Copyright &copy; 2016 <a href="https://microbit.vn">Microbit Việt Nam</a></p>
    
  </div>

  
</footer>
	  
        </div>
      </div>

    </section>

  </div>

<!-- <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/microbitvn/help.microbit.vn" class="icon icon-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../temperature-service/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../ble-connection-events/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div> -->

<script type="text/javascript">
  // If cookie is defined toggle the id
  if (typeof $.cookie('docToggle') !== 'undefined') {
      // Parse cookie which is an array
      var _parsed_cookie = JSON.parse($.cookie('docToggle'));
      // Loop over array and show hidden divs
      $.each(_parsed_cookie, function(index, value) {
          // Toggle
          $("[id='hidden_" + value + "']").css('display','');
      })
  }
</script>

</body>
</html>